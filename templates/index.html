<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/static/css/styles.css" />
    <title>NZ Wildlife</title>
</head>
<body>
    <!-- Fixed header - NOW includes favourites link -->
    <header class="top-header">
        <div class="auth-links">
            <a href="/" class="auth-link active">HOME / KĀINGA</a>
            <a href="/favourites" class="auth-link">FAVOURITES / MAKAU</a>
            <a href="/login" class="auth-link">LOG IN / TAKIURU</a>
            <a href="/register" class="auth-link">REGISTER / REHITA</a>
        </div>
    </header>

    <!-- Main content - everything else goes here -->
    <main class="main-content">
        <h1>The NZ Wildlife Program <br> te kararehe hōtaka NZ</h1>
        
        <!-- Search form -->
        <form action="/species" method="get">
            <div class="search-container">
                <div class="search-wrapper">
                    <input type="text" id="search-box" name="name" class="search-input" placeholder="Search..." autocomplete="off">
                    <div id="search-dropdown" class="search-dropdown"></div>
                </div>
                <button type="submit">Search / mohaha</button>
            </div>
            <br>
            <input type="hidden" name="field" value="species_name">
        </form>
        

        <h2>All Species Data / Raraunga Katoa</h2>
            
        <div class="species-grid">
            {% for item in species %}
            <div class="species-card">
                <button class="star-button" onclick="toggleFavourite({{ item[0] }})" id="star-{{ item[0] }}">
                    <span class="star-icon">☆</span>
                </button>
                <img src="{{ item[10] if item[10] and item[10] != '' else 'https://via.placeholder.com/400x300/4a3c28/f5f3f0?text=' + item[1]|urlencode }}" alt="{{ item[1] }} image" class="species-card-image">
                <div class="species-card-content">
                    <div class="species-card-title">{{ item[1] }}</div>
                    <div class="species-card-subtitle">{{ item[2] }}</div>
                    <div class="species-card-details">
                        <div class="species-card-detail">
                            <span class="species-card-label">Type:</span>
                            <span class="species-card-value">{{ item[3] }}</span>
                        </div>
                        <div class="species-card-detail">
                            <span class="species-card-label">Status:</span>
                            <span class="species-card-value">{{ item[7] }}</span>
                        </div>
                        <div class="species-card-detail">
                            <span class="species-card-label">Family:</span>
                            <span class="species-card-value">{{ item[8] }}</span>
                        </div>
                        <div class="species-card-detail">
                            <span class="species-card-label">Numbers:</span>
                            <span class="species-card-value">{{ item[9] }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <h2>Origin Status</h2>
        <div class="table-wrapper">
            <table border="1">
                <tr>
                    <th>ID</th>
                    <th>Origin Status</th>
                </tr>
                {% for item in origin_status %}
                <tr>
                    <td>{{ item[0] }}</td>
                    <td>{{ item[1] }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>

        <h2>Species Type</h2>
        <table border="1">
            <tr>
                <th>ID</th>
                <th>Species Type</th>
            </tr>
            {% for item in species_type %}
            <tr>
                <td>{{ item[0] }}</td>
                <td>{{ item[1] }}</td>
            </tr>
            {% endfor %}
        </table>
    </main>

    <script>
        // Function to get favourites from localStorage
        function getFavourites() {
            const favourites = localStorage.getItem('wildlife_favourites');
            return favourites ? JSON.parse(favourites) : [];
        }

        // Function to save favourites to localStorage
        function saveFavourites(favourites) {
            localStorage.setItem('wildlife_favourites', JSON.stringify(favourites));
        }

        // Function to toggle favourite status
        function toggleFavourite(speciesId) {
            let favourites = getFavourites();
            const starButton = document.getElementById('star-' + speciesId);
            const starIcon = starButton.querySelector('.star-icon');
            
            const index = favourites.indexOf(speciesId);
            
            if (index > -1) {
                // Remove from favourites
                favourites.splice(index, 1);
                starButton.classList.remove('favourited');
                starIcon.textContent = '☆';
            } else {
                // Add to favourites
                favourites.push(speciesId);
                starButton.classList.add('favourited');
                starIcon.textContent = '★';
            }
            
            saveFavourites(favourites);
            
            // Add a little animation feedback
            starButton.style.transform = 'scale(1.3)';
            setTimeout(() => {
                starButton.style.transform = 'scale(1)';
            }, 200);
        }

        // Function to initialize star states on page load
        function initializeStars() {
            const favourites = getFavourites();
            
            favourites.forEach(speciesId => {
                const starButton = document.getElementById('star-' + speciesId);
                const starIcon = starButton ? starButton.querySelector('.star-icon') : null;
                
                if (starButton && starIcon) {
                    starButton.classList.add('favourited');
                    starIcon.textContent = '★';
                }
            });
        }

        // Search dropdown functionality
        let searchTimeout;
        let currentHighlightIndex = -1;
        
        function setupSearchDropdown() {
            const searchBox = document.getElementById('search-box');
            const searchDropdown = document.getElementById('search-dropdown');
            
            if (!searchBox || !searchDropdown) return;
            
            searchBox.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length < 2) {
                    searchDropdown.classList.remove('show');
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    fetch('/api/search-suggestions?q=' + encodeURIComponent(query))
                        .then(response => response.json())
                        .then(data => {
                            displaySuggestions(data.suggestions);
                        })
                        .catch(error => {
                            console.error('Search error:', error);
                            searchDropdown.classList.remove('show');
                        });
                }, 300);
            });
            
            // Handle keyboard navigation
            searchBox.addEventListener('keydown', function(e) {
                const items = searchDropdown.querySelectorAll('.dropdown-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentHighlightIndex = Math.min(currentHighlightIndex + 1, items.length - 1);
                    updateHighlight(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentHighlightIndex = Math.max(currentHighlightIndex - 1, -1);
                    updateHighlight(items);
                } else if (e.key === 'Enter' && currentHighlightIndex >= 0) {
                    e.preventDefault();
                    if (items[currentHighlightIndex]) {
                        selectSuggestion(items[currentHighlightIndex].dataset.text);
                    }
                } else if (e.key === 'Escape') {
                    searchDropdown.classList.remove('show');
                    currentHighlightIndex = -1;
                }
            });
            
            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchBox.contains(e.target) && !searchDropdown.contains(e.target)) {
                    searchDropdown.classList.remove('show');
                    currentHighlightIndex = -1;
                }
            });
        }
        
        function displaySuggestions(suggestions) {
            const searchDropdown = document.getElementById('search-dropdown');
            
            if (suggestions.length === 0) {
                searchDropdown.classList.remove('show');
                return;
            }
            
            searchDropdown.innerHTML = suggestions.map(suggestion => {
                // Escape quotes in the text for the onclick attribute
                const escapedText = suggestion.text.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                return `
                    <div class="dropdown-item" data-text="${suggestion.text}" onclick="selectSuggestion('${escapedText}')">
                        <span class="dropdown-item-text">${suggestion.text}</span>
                        <span class="dropdown-item-type">${suggestion.type}</span>
                    </div>
                `;
            }).join('');
            
            searchDropdown.classList.add('show');
            currentHighlightIndex = -1;
        }
        
        function updateHighlight(items) {
            items.forEach((item, index) => {
                if (index === currentHighlightIndex) {
                    item.classList.add('highlighted');
                } else {
                    item.classList.remove('highlighted');
                }
            });
        }
        
        function selectSuggestion(text) {
            const searchBox = document.getElementById('search-box');
            const searchDropdown = document.getElementById('search-dropdown');
            
            searchBox.value = text;
            searchDropdown.classList.remove('show');
            currentHighlightIndex = -1;
            
            // Submit the form
            searchBox.closest('form').submit();
        }

                // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeStars();
            setupSearchDropdown();
        });
    </script>

</body>
</html>