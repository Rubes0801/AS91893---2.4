<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/static/css/styles.css" />
    <title>NZ Wildlife</title>
</head>
<body>
    <header class="top-header">
        <a href="/" class="logo-container">
            <img src="/static/images/nz-wildlife-logo.png" alt="NZ Wildlife Logo" class="logo-image">
        </a>
        <div class="auth-links">
            <a href="/" class="auth-link active">HOME / KĀINGA</a>
            <a href="/favourites" class="auth-link">FAVOURITES / MAKAU</a>
            <a href="/map" class="auth-link">MAP / MAPI</a>
            <a href="/about" class="auth-link">ABOUT / MŌ MĀTOU</a>
            <a href="/login" class="auth-link">LOG IN / TAKIURU</a>
            <a href="/register" class="auth-link">REGISTER / REHITA</a>
        </div>
    </header>

    <!-- Main content - everything else goes here -->
    <main class="main-content">
        <h1>The NZ Wildlife Program <br> te kararehe hōtaka NZ</h1>
        
        <!-- Search form -->
        <form action="/species" method="get">
            <div class="search-container">
                <div class="search-wrapper">
                    <input type="text" id="search-box" name="name" class="search-input" placeholder="Search..." autocomplete="off">
                    <div id="search-dropdown" class="search-dropdown"></div>
                </div>
                <button type="submit">Search / mohaha</button>
            </div>
            <br>
            <input type="hidden" name="field" value="species_name">
        </form>
        
        <h2>All Species Data / Raraunga Katoa</h2>
            
        <div class="species-grid">
            {% for item in species %}
            <div class="species-card">
                <button class="star-button" onclick="toggleFavourite({{ item[0] }})" id="star-{{ item[0] }}">
                    <span class="star-icon">☆</span>
                </button>
                <img src="{% if item[10] and item[10].strip() %}{{ item[10] }}{% else %}/static/images/no-image.png{% endif %}" 
                 alt="{{ item[1] }} wildlife image" 
                 class="species-card-image"
                 onerror="this.style.display='none';">
                <div class="species-card-content">
                    <div class="species-card-title">{{ item[1] }}</div>
                    <div class="species-card-subtitle">{{ item[2] }}</div>
                    <div class="species-card-details">
                        <div class="species-card-detail">
                            <span class="species-card-label">Type:</span>
                            <span class="species-card-value">{{ item[3] }}</span>
                        </div>
                        <div class="species-card-detail">
                            <span class="species-card-label">Status:</span>
                            <span class="species-card-value">{{ item[7] }}</span>
                        </div>
                        <div class="species-card-detail">
                            <span class="species-card-label">Family:</span>
                            <span class="species-card-value">{{ item[8] }}</span>
                        </div>
                        <div class="species-card-detail">
                            <span class="species-card-label">Numbers:</span>
                            <span class="species-card-value">{{ item[9] }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <h2>Origin Status</h2>
        <div class="table-wrapper">
            <table border="1">
                <tr>
                    <th>ID</th>
                    <th>Origin Status</th>
                </tr>
                {% for item in origin_status %}
                <tr>
                    <td>{{ item[0] }}</td>
                    <td>{{ item[1] }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>

        <h2>Species Type</h2>
        <table border="1">
            <tr>
                <th>ID</th>
                <th>Species Type</th>
            </tr>
            {% for item in species_type %}
            <tr>
                <td>{{ item[0] }}</td>
                <td>{{ item[1] }}</td>
            </tr>
            {% endfor %}
        </table>
    </main>

    <script>
        console.log('JavaScript loaded successfully');

        // Favourites functionality
        function getFavourites() {
            const favourites = localStorage.getItem('wildlife_favourites');
            return favourites ? JSON.parse(favourites) : [];
        }

        function saveFavourites(favourites) {
            localStorage.setItem('wildlife_favourites', JSON.stringify(favourites));
        }

        function toggleFavourite(speciesId) {
            let favourites = getFavourites();
            const starButton = document.getElementById('star-' + speciesId);
            const starIcon = starButton.querySelector('.star-icon');
            
            const index = favourites.indexOf(speciesId);
            
            if (index > -1) {
                favourites.splice(index, 1);
                starButton.classList.remove('favourited');
                starIcon.textContent = '☆';
            } else {
                favourites.push(speciesId);
                starButton.classList.add('favourited');
                starIcon.textContent = '★';
            }
            
            saveFavourites(favourites);
            
            starButton.style.transform = 'scale(1.3)';
            setTimeout(() => {
                starButton.style.transform = 'scale(1)';
            }, 200);
        }

        function initializeStars() {
            const favourites = getFavourites();
            
            favourites.forEach(speciesId => {
                const starButton = document.getElementById('star-' + speciesId);
                const starIcon = starButton ? starButton.querySelector('.star-icon') : null;
                
                if (starButton && starIcon) {
                    starButton.classList.add('favourited');
                    starIcon.textContent = '★';
                }
            });
        }

        // Search dropdown functionality - FIXED VERSION
        let searchTimeout;
        let currentHighlightIndex = -1;

        function setupSearchDropdown() {
            console.log('Setting up search dropdown...');
            const searchBox = document.getElementById('search-box');
            const searchDropdown = document.getElementById('search-dropdown');
            
            if (!searchBox || !searchDropdown) {
                console.error('Search elements not found!');
                return;
            }

            console.log('Search elements found successfully');
            
            // Show dropdown when search box is clicked or focused
            searchBox.addEventListener('focus', function(e) {
                console.log('Search box focused');
                e.stopPropagation();
                showAllSuggestions();
            });

            searchBox.addEventListener('click', function(e) {
                console.log('Search box clicked');
                e.stopPropagation();
                showAllSuggestions();
            });

            // Handle input changes
            searchBox.addEventListener('input', function() {
                console.log('Input changed:', this.value);
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length === 0) {
                    showAllSuggestions();
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    fetchSuggestions(query);
                }, 200);
            });
            
            // Handle keyboard navigation
            searchBox.addEventListener('keydown', function(e) {
                const items = searchDropdown.querySelectorAll('.dropdown-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentHighlightIndex = Math.min(currentHighlightIndex + 1, items.length - 1);
                    updateHighlight(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentHighlightIndex = Math.max(currentHighlightIndex - 1, -1);
                    updateHighlight(items);
                } else if (e.key === 'Enter' && currentHighlightIndex >= 0) {
                    e.preventDefault();
                    if (items[currentHighlightIndex]) {
                        selectSuggestion(items[currentHighlightIndex].dataset.text);
                    }
                } else if (e.key === 'Escape') {
                    hideDropdown();
                }
            });
            
            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchBox.contains(e.target) && !searchDropdown.contains(e.target)) {
                    console.log('Clicking outside - hiding dropdown');
                    hideDropdown();
                }
            });

            // Prevent dropdown from closing when clicking inside it
            searchDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }

        function showAllSuggestions() {
            console.log('Showing all suggestions...');
            const searchDropdown = document.getElementById('search-dropdown');
            
            searchDropdown.innerHTML = '<div class="dropdown-loading">Loading all species...</div>';
            searchDropdown.classList.add('show');
            
            fetch('/api/search-suggestions?show_all=true')
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received data:', data);
                    displaySuggestions(data.suggestions || []);
                })
                .catch(error => {
                    console.error('Search error:', error);
                    searchDropdown.innerHTML = '<div class="dropdown-loading">Error loading suggestions</div>';
                });
        }

        function fetchSuggestions(query) {
            console.log('Fetching suggestions for:', query);
            const searchDropdown = document.getElementById('search-dropdown');
            
            searchDropdown.innerHTML = '<div class="dropdown-loading">Searching...</div>';
            searchDropdown.classList.add('show');
            
            fetch('/api/search-suggestions?q=' + encodeURIComponent(query))
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received search data:', data);
                    displaySuggestions(data.suggestions || []);
                })
                .catch(error => {
                    console.error('Search error:', error);
                    searchDropdown.innerHTML = '<div class="dropdown-loading">Error searching</div>';
                });
        }

        function displaySuggestions(suggestions) {
            console.log('Displaying suggestions:', suggestions);
            const searchDropdown = document.getElementById('search-dropdown');
            
            if (!suggestions || suggestions.length === 0) {
                searchDropdown.innerHTML = '<div class="dropdown-loading">No suggestions found</div>';
                return;
            }
            
            searchDropdown.innerHTML = suggestions.map(suggestion => {
                const escapedText = suggestion.text.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                return `
                    <div class="dropdown-item" data-text="${suggestion.text}" onclick="selectSuggestion('${escapedText}')">
                        <span class="dropdown-item-text">${suggestion.text}</span>
                        <span class="dropdown-item-type">${suggestion.type}</span>
                    </div>
                `;
            }).join('');
            
            searchDropdown.classList.add('show');
            currentHighlightIndex = -1;
        }

        function updateHighlight(items) {
            items.forEach((item, index) => {
                if (index === currentHighlightIndex) {
                    item.classList.add('highlighted');
                } else {
                    item.classList.remove('highlighted');
                }
            });
        }

        function selectSuggestion(text) {
            console.log('Selected suggestion:', text);
            const searchBox = document.getElementById('search-box');
            
            searchBox.value = text;
            hideDropdown();
            
            searchBox.closest('form').submit();
        }

        function hideDropdown() {
            console.log('Hiding dropdown');
            const searchDropdown = document.getElementById('search-dropdown');
            searchDropdown.classList.remove('show');
            currentHighlightIndex = -1;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded - initializing...');
            initializeStars();
            setupSearchDropdown();
        });

        // Active navigation highlighting
        document.addEventListener('DOMContentLoaded', function() {
            const style = document.createElement('style');
            style.textContent = `
                .auth-link.active {
                    background: rgba(127, 176, 105, 0.2);
                    border-color: var(--accent-color);
                    color: var(--accent-color);
                }
            `;
            document.head.appendChild(style);
            
            const currentPath = window.location.pathname;
            const authLinks = document.querySelectorAll('.auth-link');
            
            authLinks.forEach(link => link.classList.remove('active'));
            
            authLinks.forEach(link => {
                const href = link.getAttribute('href');
                if ((currentPath === '/' && href === '/') ||
                    (currentPath !== '/' && href !== '/' && currentPath.startsWith(href))) {
                    link.classList.add('active');
                }
            });
        });
    </script>
    <script>
document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelectorAll('img');
    images.forEach(img => {
        img.onerror = function() {
            this.style.display = 'none'; // Hide broken images
            // Or replace with a local fallback:
            // this.src = '/static/images/no-image.png';
        };
    });
});
</script>
</body>
</html>